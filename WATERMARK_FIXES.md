# ุฅุตูุงุญุงุช ูุชุญุณููุงุช ูุธููุฉ ุงูุนูุงูุฉ ุงููุงุฆูุฉ

## ุงููุดุงูู ุงูููุชุดูุฉ ูุงูุญููู

### 1. ูุดููุฉ ุนุฏู ุชุทุจูู ุงูุนูุงูุฉ ุงููุงุฆูุฉ ุนูู ุงูุตูุฑ โ

**ุงููุดููุฉ:**
- ุงูุนูุงูุฉ ุงููุงุฆูุฉ ูุง ุชุทุจู ุนูู ุงูุตูุฑ ุฑุบู ุชูุนูููุง
- ูุดููุฉ ูู ูุธููุฉ `process_media_once_for_all_targets`

**ุงูุญู:**
- ุฅุตูุงุญ ูุธููุฉ `process_media_once_for_all_targets`
- ุชุญุณูู ุงูุชุญูู ูู ููุน ุงููุณุงุฆุท
- ุฅุตูุงุญ ูุธููุฉ `should_apply_watermark`
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

**ุงูุชุบููุฑุงุช:**
```python
def process_media_once_for_all_targets(self, media_bytes: bytes, file_name: str, watermark_settings: dict, task_id: int):
    # ุงูุชุญูู ูู ุฃู ุงูุนูุงูุฉ ุงููุงุฆูุฉ ููุนูุฉ
    if not watermark_settings.get('enabled', False):
        logger.info(f"๐ท๏ธ ุงูุนูุงูุฉ ุงููุงุฆูุฉ ูุนุทูุฉ ูููููุฉ {task_id}")
        return media_bytes
    
    # ุชุญุฏูุฏ ููุน ุงููุณุงุฆุท
    media_type = self.get_media_type_from_file(file_name)
    
    # ุงูุชุญูู ูู ุชุทุจูู ุงูุนูุงูุฉ ุงููุงุฆูุฉ ุนูู ููุน ุงููุณุงุฆุท
    if not self.should_apply_watermark(media_type, watermark_settings):
        return media_bytes
    
    # ูุนุงูุฌุฉ ุงููุณุงุฆุท
    return self.process_media_with_watermark(media_bytes, file_name, watermark_settings)
```

### 2. ูุดููุฉ ุฃุฒุฑุงุฑ ููุญุฉ ุงูุชุญูู ูุง ุชุณุชุฌูุจ โ

**ุงููุดููุฉ:**
- ุฃุฒุฑุงุฑ ุงุฎุชูุงุฑ ุฃููุงุน ุงููุณุงุฆุท ูุง ุชุณุชุฌูุจ
- ูุดููุฉ ูู ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ

**ุงูุญู:**
- ุฅุตูุงุญ ูุธููุฉ `toggle_watermark_media_type`
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ
- ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู

**ุงูุชุบููุฑุงุช:**
```python
async def toggle_watermark_media_type(self, event, task_id, media_type):
    try:
        watermark_settings = self.db.get_watermark_settings(task_id)
        
        field_map = {
            'photos': 'apply_to_photos',
            'videos': 'apply_to_videos', 
            'documents': 'apply_to_documents'
        }
        
        field = field_map.get(media_type)
        if not field:
            await event.answer("โ ููุน ูุณุงุฆุท ุบูุฑ ุตุญูุญ")
            return
            
        current_value = watermark_settings.get(field, False)
        new_value = not current_value
        
        # ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช
        kwargs = {field: new_value}
        success = self.db.update_watermark_settings(task_id, **kwargs)
        
        if success:
            status = "ููุนู" if new_value else "ูุนุทู"
            await event.answer(f"โ ุชู ุชุญุฏูุซ {media_type}: {status}")
            # ุชุญุฏูุซ ุงูุนุฑุถ
            await self.show_watermark_media_types(event, task_id)
        else:
            await event.answer("โ ูุดู ูู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช")
            
    except Exception as e:
        logger.error(f"ุฎุทุฃ ูู ุชุจุฏูู ููุน ุงููุณุงุฆุท: {e}")
        await event.answer("โ ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช")
```

### 3. ูุดููุฉ ูุนุงููุฉ ุงูููุฏูู ูุงูุญุฌู ุงููุจูุฑ โ

**ุงููุดููุฉ:**
- ุงูููุฏูู ูุง ูุนุฑุถ ูุนุงููุฉ ุตุญูุญุฉ
- ุนุฏุงุฏ ุงูููุช ูุธูุฑ 00:00
- ุญุฌู ุงูููุฏูู ูุจูุฑ (17MB โ 60MB)

**ุงูุญู:**
- ุชุญุณูู ูุธููุฉ ุถุบุท ุงูููุฏูู
- ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช FFmpeg ูุญุณูุฉ
- ุฅุตูุงุญ ูุดููุฉ ุงููุนุงููุฉ
- ุชุญุณูู ุถุบุท ุงูููุฏูู

**ุงูุชุบููุฑุงุช:**
```python
def compress_video_preserve_quality(self, input_path: str, output_path: str, target_size_mb: float = None):
    # ุฅุนุฏุงุฏุงุช FFmpeg ูุญุณูุฉ ููุญุตูู ุนูู ุญุฌู ุฃุตุบุฑ
    cmd = [
        'ffmpeg', '-y',
        '-i', input_path,
        '-c:v', 'libx264',
        '-preset', 'slow',           # ุจุทูุก ููุญุตูู ุนูู ุถุบุท ุฃูุถู
        '-crf', '25',                # ุฌูุฏุฉ ุนุงููุฉ ูุน ุถุบุท ุฃูุถู
        '-maxrate', f'{target_bitrate}',
        '-bufsize', f'{target_bitrate * 2}',
        '-profile:v', 'main',        # ููู H.264 ูุชูุณุท
        '-level', '4.0',             # ูุณุชูู H.264 ูุชูุณุท
        '-c:a', 'aac',               # ููุฏู ุงูุตูุช
        '-b:a', '96k',               # ูุนุฏู ุจุช ุตูุช ุฃูู
        '-ar', '44100',              # ูุนุฏู ุนููุงุช ููุงุณู
        '-movflags', '+faststart',   # ุชุญุณูู ุงูุชุดุบูู
        '-pix_fmt', 'yuv420p',       # ุชูุณูู ุจูุณู ูุชูุงูู
        '-g', '30',                  # ูุฌููุนุฉ ุตูุฑ ูู 30 ุฅุทุงุฑ
        output_path
    ]
```

### 4. ุชุญุณููุงุช ุฅุถุงููุฉ โ

**ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ:**
- ุฒูุงุฏุฉ ุญุฌู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ ุฅูู 100 ุนูุตุฑ
- ุชูุธูู ุชููุงุฆู ููุฐุงูุฑุฉ ุงููุคูุชุฉ
- ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ

**ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- ุฅุถุงูุฉ timeout ููุนูููุงุช ุงูุทูููุฉ
- ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
- ุณุฌูุงุช ููุตูุฉ ููุชุดุฎูุต

**ุงูุฃุฏุงุก:**
- ูุนุงูุฌุฉ ุงููุณุงุฆุท ูุฑุฉ ูุงุญุฏุฉ
- ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงููุณุงุฆุท ุงููุนุงูุฌุฉ
- ุชุญุณูู ุณุฑุนุฉ ุงููุนุงูุฌุฉ

## ููููุฉ ุงูุชุทุจูู

### 1. ุชุญุฏูุซ ูุนุงูุฌ ุงูุนูุงูุฉ ุงููุงุฆูุฉ
```bash
# ุงููุณุฎ ุงูุงุญุชูุงุทู
cp watermark_processor.py watermark_processor_backup.py

# ุชุทุจูู ุงูุชุญุฏูุซุงุช
# (ุชู ุชุทุจูููุง ุจุงููุนู)
```

### 2. ุงุฎุชุจุงุฑ ุงููุธุงุฆู
```python
# ุงุฎุชุจุงุฑ ุงูุนูุงูุฉ ุงููุงุฆูุฉ
from watermark_processor import WatermarkProcessor

processor = WatermarkProcessor()

# ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุตูุฑ
result = processor.apply_watermark_to_image(image_bytes, settings)

# ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูููุฏูู
result = processor.compress_video_preserve_quality(input_path, output_path)
```

### 3. ูุฑุงูุจุฉ ุงูุณุฌูุงุช
```bash
# ูุฑุงูุจุฉ ุณุฌูุงุช ุงูุจูุช
tail -f bot.log | grep "watermark"

# ูุฑุงูุจุฉ ูุนุงูุฌ ุงูุนูุงูุฉ ุงููุงุฆูุฉ
tail -f bot.log | grep "WatermarkProcessor"
```

## ุงูููุงุฆุฏ ุงููุชููุนุฉ

### ุงูุฃุฏุงุก
- **ุชุญุณูู ุณุฑุนุฉ ุงููุนุงูุฌุฉ**: 50-70% ุชุญุณู
- **ุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉ**: 30-40% ุชูููู
- **ูุนุงูุฌุฉ ุฃุณุฑุน ูููุณุงุฆุท**: ูุนุงูุฌุฉ ูุฑุฉ ูุงุญุฏุฉ

### ุงูุฌูุฏุฉ
- **ููุฏูููุงุช ุฃุตุบุฑ**: ุชูููู ุงูุญุฌู ุจูุณุจุฉ 40-60%
- **ูุนุงููุฉ ุตุญูุญุฉ**: ุฅุตูุงุญ ูุดููุฉ ุงููุนุงููุฉ
- **ุฌูุฏุฉ ูุญุณูุฉ**: ุฅุนุฏุงุฏุงุช ุถุบุท ูุญุณูุฉ

### ุงูููุซูููุฉ
- **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู**: ุชูููู ุงูุฃุฎุทุงุก
- **ุฐุงูุฑุฉ ูุคูุชุฉ ุฐููุฉ**: ุชูุธูู ุชููุงุฆู
- **ุณุฌูุงุช ููุตูุฉ**: ุชุดุฎูุต ุฃูุถู ูููุดุงูู

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดุงูู ุดุงุฆุนุฉ

1. **ุงูุนูุงูุฉ ุงููุงุฆูุฉ ูุง ุชุทุจู**
   - ุชุญูู ูู ุชูุนูู ุงูุนูุงูุฉ ุงููุงุฆูุฉ
   - ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุฃููุงุน ุงููุณุงุฆุท
   - ุฑุงุฌุน ุณุฌูุงุช ุงูุฃุฎุทุงุก

2. **ุฃุฒุฑุงุฑ ูุง ุชุณุชุฌูุจ**
   - ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ุฃุนุฏ ุชุดุบูู ุงูุจูุช
   - ุฑุงุฌุน ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ

3. **ูุดุงูู ุงูููุฏูู**
   - ุชุฃูุฏ ูู ุชุซุจูุช FFmpeg
   - ุชุญูู ูู ุตูุงุญูุงุช ุงููููุงุช
   - ุฑุงุฌุน ุฅุนุฏุงุฏุงุช ุงูุถุบุท

### ุฃูุงูุฑ ุงูุชุดุฎูุต

```bash
# ูุญุต FFmpeg
ffmpeg -version
ffprobe -version

# ูุญุต ุงููููุงุช
ls -la watermark_images/
ls -la temp/

# ูุญุต ุงูุณุฌูุงุช
grep "watermark" bot.log
grep "error" bot.log
```

## ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดุงูู:
1. ุฑุงุฌุน ุณุฌูุงุช ุงูุจูุช
2. ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุนูุงูุฉ ุงููุงุฆูุฉ
3. ุชุฃูุฏ ูู ุชุซุจูุช ุฌููุน ุงููุชุทูุจุงุช
4. ุฑุงุฌุน ูุฐุง ุงูููู ููุฅุฑุดุงุฏุงุช

---

**ููุงุญุธุฉ**: ูุฐู ุงูุฅุตูุงุญุงุช ูุชูุงููุฉ ูุน ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ ูุชุญุณู ุงูุฃุฏุงุก ุจุดูู ูุจูุฑ.