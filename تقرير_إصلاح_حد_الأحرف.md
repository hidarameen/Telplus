# ุชูุฑูุฑ ุฅุตูุงุญ ุญุฏ ุงูุฃุญุฑู

## ๐จ ุงููุดููุฉ ุงูููุชุดูุฉ

### ุงูุฎุทุฃ:
```
sqlite3.OperationalError: no such column: action_type
```

### ุงูุณุจุจ:
ูุงู ุงูููุฏ ูุญุงูู ุงููุตูู ุฅูู ุนููุฏ `action_type` ูู ุฌุฏูู `task_character_limit_settings`ุ ููู ูุฐุง ุงูุนููุฏ ุบูุฑ ููุฌูุฏ ูู ุจููุฉ ุงูุฌุฏูู ุงูุญุงููุฉ.

### ุจููุฉ ุงูุฌุฏูู ุงูุญุงููุฉ:
```sql
CREATE TABLE task_character_limit_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    enabled BOOLEAN DEFAULT FALSE,
    mode TEXT DEFAULT 'allow' CHECK (mode IN ('allow', 'block')),
    min_chars INTEGER DEFAULT 0,
    max_chars INTEGER DEFAULT 4000,
    use_range BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks (id) ON DELETE CASCADE,
    UNIQUE(task_id)
)
```

## โ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ

### 1. ุฅุตูุงุญ ุฏุงูุฉ `get_character_limit_settings`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
def get_character_limit_settings(self, task_id: int) -> Dict:
    cursor.execute('''
        SELECT enabled, action_type, min_chars, max_chars
        FROM task_character_limit_settings 
        WHERE task_id = ?
    ''', (task_id,))
    # ...
    return {
        'enabled': bool(result[0]),
        'action_type': result[1],  # โ ุฎุทุฃ: ุนููุฏ ุบูุฑ ููุฌูุฏ
        'min_chars': result[2],
        'max_chars': result[3]
    }
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
def get_character_limit_settings(self, task_id: int) -> Dict:
    cursor.execute('''
        SELECT enabled, mode, min_chars, max_chars, use_range
        FROM task_character_limit_settings 
        WHERE task_id = ?
    ''', (task_id,))
    # ...
    return {
        'enabled': bool(result[0]),
        'mode': result[1],  # โ ุตุญูุญ: ุนููุฏ ููุฌูุฏ
        'min_chars': result[2],
        'max_chars': result[3],
        'use_range': bool(result[4])
    }
```

### 2. ุฅุตูุงุญ ุฏุงูุฉ `update_character_limit_settings`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
# Create default settings if not exists
cursor.execute('''
    INSERT INTO task_character_limit_settings 
    (task_id, enabled, action_type, min_chars, max_chars)
    VALUES (?, FALSE, 'max_limit', 10, 1000)
''', (task_id,))

# Check allowed columns
if key in ['enabled', 'action_type', 'min_chars', 'max_chars']:
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
# Create default settings if not exists
cursor.execute('''
    INSERT INTO task_character_limit_settings 
    (task_id, enabled, mode, min_chars, max_chars, use_range)
    VALUES (?, FALSE, 'allow', 0, 4000, TRUE)
''', (task_id,))

# Check allowed columns
if key in ['enabled', 'mode', 'min_chars', 'max_chars', 'use_range']:
```

### 3. ุฅุตูุงุญ ุฏุงูุฉ `cycle_character_limit_mode`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
def cycle_character_limit_mode(self, task_id: int) -> str:
    current_mode = settings['action_type']
    
    # Cycle through modes
    if current_mode == 'max_limit':
        new_mode = 'min_limit'
    elif current_mode == 'min_limit':
        new_mode = 'range'
    else:  # range
        new_mode = 'max_limit'
    
    self.update_character_limit_settings(task_id, action_type=new_mode)
    return new_mode
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
def cycle_character_limit_mode(self, task_id: int) -> str:
    current_mode = settings['mode']
    
    # Cycle through modes
    if current_mode == 'allow':
        new_mode = 'block'
    else:  # block
        new_mode = 'allow'
    
    self.update_character_limit_settings(task_id, mode=new_mode)
    return new_mode
```

### 4. ุฅุตูุงุญ ุฏุงูุฉ `update_character_limit_values`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
def update_character_limit_values(self, task_id: int, min_chars: int = None, max_chars: int = None) -> bool:
    # Determine the correct action_type based on final values
    if current_min > 0 and current_max > 0:
        updates['action_type'] = 'range'
    elif current_min > 0 and current_max == 0:
        updates['action_type'] = 'min_limit'
    elif current_max > 0 and current_min == 0:
        updates['action_type'] = 'max_limit'
    else:
        updates['action_type'] = 'max_limit'
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
def update_character_limit_values(self, task_id: int, min_chars: int = None, max_chars: int = None) -> bool:
    # Update the values
    updates = {}
    if min_chars is not None:
        updates['min_chars'] = min_chars
    if max_chars is not None:
        updates['max_chars'] = max_chars
    
    if updates:
        return self.update_character_limit_settings(task_id, **updates)
    return False
```

### 5. ุฅุตูุงุญ ูุงุฌูุฉ ุงููุณุชุฎุฏู ูู `bot_simple.py`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
mode_map = {
    'max_limit': '๐บ ุญุฏ ุฃูุตู',
    'min_limit': '๐ป ุญุฏ ุฃุฏูู', 
    'range': '๐ ูุทุงู ูุญุฏุฏ'
}
current_mode = settings['action_type']
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
mode_map = {
    'allow': 'โ ุงูุณูุงุญ',
    'block': 'โ ุงูุญุธุฑ'
}
current_mode = settings['mode']
```

### 6. ุฅุตูุงุญ ููุทู ุงููุญุต ูู `userbot.py`:

**ูุจู ุงูุฅุตูุงุญ:**
```python
action_type = settings.get('action_type', 'max_limit')

if action_type == 'min_limit':
    # Minimum limit logic
elif action_type == 'max_limit':
    # Maximum limit logic
elif action_type == 'range':
    # Range limit logic
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```python
mode = settings.get('mode', 'allow')
use_range = settings.get('use_range', True)

if mode == 'allow':
    # Allow mode logic
elif mode == 'block':
    # Block mode logic
```

### 7. ุฅุถุงูุฉ ุฏุงูุฉ ุชุญุฏูุซ ุจููุฉ ุงูุฌุฏูู:

```python
def update_character_limit_table(self):
    """Update character limit table structure if needed"""
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            
            # Check if mode column exists
            cursor.execute("PRAGMA table_info(task_character_limit_settings)")
            columns = [column[1] for column in cursor.fetchall()]
            
            # Add missing columns
            if 'mode' not in columns:
                cursor.execute('ALTER TABLE task_character_limit_settings ADD COLUMN mode TEXT DEFAULT "allow" CHECK (mode IN ("allow", "block"))')
                logger.info("โ ุชู ุฅุถุงูุฉ ุนููุฏ mode ุฅูู ุฌุฏูู task_character_limit_settings")
            
            if 'use_range' not in columns:
                cursor.execute('ALTER TABLE task_character_limit_settings ADD COLUMN use_range BOOLEAN DEFAULT TRUE')
                logger.info("โ ุชู ุฅุถุงูุฉ ุนููุฏ use_range ุฅูู ุฌุฏูู task_character_limit_settings")
            
            # Update existing records
            cursor.execute('''
                UPDATE task_character_limit_settings 
                SET mode = 'allow', use_range = TRUE 
                WHERE mode IS NULL OR use_range IS NULL
            ''')
            
            conn.commit()
            logger.info("โ ุชู ุชุญุฏูุซ ุจููุฉ ุฌุฏูู ุญุฏ ุงูุฃุญุฑู ุจูุฌุงุญ")
            
    except Exception as e:
        logger.error(f"ุฎุทุฃ ูู ุชุญุฏูุซ ุจููุฉ ุฌุฏูู ุญุฏ ุงูุฃุญุฑู: {e}")
```

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### โ ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏุงุช:
```
โ ุงูุฅุนุฏุงุฏุงุช: {'enabled': False, 'mode': 'allow', 'min_chars': 0, 'max_chars': 4000, 'use_range': True}
โ ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช: True
โ ุงูุฅุนุฏุงุฏุงุช ุงููุญุฏุซุฉ: {'enabled': True, 'mode': 'allow', 'min_chars': 10, 'max_chars': 1000, 'use_range': True}
โ ุงููุถุน ุงูุฌุฏูุฏ: block
โ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ: False
```

### โ ุงุฎุชุจุงุฑ ุงูููู:
```
โ ุชุญุฏูุซ ุงูููู: True
โ ุงูุฅุนุฏุงุฏุงุช: {'enabled': False, 'mode': 'block', 'min_chars': 50, 'max_chars': 500, 'use_range': True}
```

## ๐ฏ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. ุจููุฉ ุงูุฌุฏูู ุงููุญุณูุฉ:
- โ **ุนููุฏ `mode`**: ููุชุญูู ูู ุงููุถุน (allow/block)
- โ **ุนููุฏ `use_range`**: ููุชุญูู ูู ุงุณุชุฎุฏุงู ุงููุทุงู
- โ **ููู ุงูุชุฑุงุถูุฉ ูุญุณูุฉ**: min_chars=0, max_chars=4000

### 2. ููุทู ุงููุญุต ุงููุญุณู:
- โ **ูุถุน ุงูุณูุงุญ**: ูุณูุญ ุจุงูุฑุณุงุฆู ุงููุทุงุจูุฉ ููุดุฑูุท
- โ **ูุถุน ุงูุญุธุฑ**: ูุญุธุฑ ุงูุฑุณุงุฆู ุบูุฑ ุงููุทุงุจูุฉ ููุดุฑูุท
- โ **ุฏุนู ุงููุทุงู**: ูุญุต ุงูุญุฏ ุงูุฃุฏูู ูุงูุฃูุตู ูุนุงู

### 3. ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงููุญุณูุฉ:
- โ **ุฑููุฒ ูุงุถุญุฉ**: โ ููุณูุงุญุ โ ููุญุธุฑ
- โ **ูุตู ูุงุถุญ**: ุดุฑุญ ุงูุฃูุถุงุน ุงููุชุงุญุฉ
- โ **ุฃุฒุฑุงุฑ ูุญุณูุฉ**: ุชุนุฏูู ุงูุญุฏ ุงูุฃุฏูู ูุงูุฃูุตู

### 4. ุงูุชูุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- โ **ุชุญุฏูุซ ุชููุงุฆู**: ุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูููููุฏุฉ
- โ **ุชุฑุญูู ุงูุจูุงูุงุช**: ุชุญุฏูุซ ุงูุณุฌูุงุช ุงูููุฌูุฏุฉ
- โ **ููู ุงูุชุฑุงุถูุฉ**: ุถูุงู ูุฌูุฏ ููู ุตุญูุญุฉ

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

### `database/database.py`:
- **ุงูุณุทุฑ 3812-3830**: ุฅุตูุงุญ `get_character_limit_settings`
- **ุงูุณุทุฑ 3831-3870**: ุฅุตูุงุญ `update_character_limit_settings`
- **ุงูุณุทุฑ 4335-4350**: ุฅุตูุงุญ `cycle_character_limit_mode`
- **ุงูุณุทุฑ 4351-4370**: ุฅุตูุงุญ `update_character_limit_values`
- **ุงูุณุทุฑ 4410-4420**: ุฅุตูุงุญ `toggle_character_limit`
- **ุฅุถุงูุฉ ุฏุงูุฉ `update_character_limit_table`**

### `bot_package/bot_simple.py`:
- **ุงูุณุทุฑ 9840-9890**: ุฅุตูุงุญ ุนุฑุถ ุฅุนุฏุงุฏุงุช ุญุฏ ุงูุฃุญุฑู
- **ุงูุณุทุฑ 9890-9920**: ุฅุตูุงุญ ุฏุงูุฉ `cycle_character_limit_mode`

### `userbot_service/userbot.py`:
- **ุงูุณุทุฑ 2200-2250**: ุฅุตูุงุญ ููุทู ูุญุต ุญุฏ ุงูุฃุญุฑู

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจูุฌุงุญ:

### โ ุงููุดุงูู ุงููุญูููุฉ:
1. **ุฎุทุฃ `no such column: action_type`** - ุชู ุฅุตูุงุญู
2. **ุนุฏู ุชูุงูู ุจููุฉ ุงูุฌุฏูู** - ุชู ุชุญุฏูุซู
3. **ููุทู ุงููุญุต ุงููุนุทู** - ุชู ุฅุตูุงุญู
4. **ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงููุนุทูุฉ** - ุชู ุฅุตูุงุญูุง

### ๐ ุงูุฅุญุตุงุฆูุงุช:
- **3 ูููุงุช** ุชู ุชุนุฏูููุง
- **8 ุฏูุงู** ุชู ุฅุตูุงุญูุง
- **ุฌุฏูู ูุงุนุฏุฉ ุจูุงูุงุช** ุชู ุชุญุฏูุซู
- **ุงุฎุชุจุงุฑุงุช ุดุงููุฉ** ุชุคูุฏ ุงูุฅุตูุงุญ

### ๐ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- **ูุถุน ุงูุณูุงุญ/ุงูุญุธุฑ** ุจุฏูุงู ูู ุงูุญุฏ ุงูุฃุฏูู/ุงูุฃูุตู/ุงููุทุงู
- **ุฏุนู ุงููุทุงู** ูุน ุฎูุงุฑ ุชูุนูู/ุชุนุทูู
- **ููู ุงูุชุฑุงุถูุฉ ูุญุณูุฉ** (0-4000 ุญุฑู)
- **ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ** ูุน ุฑููุฒ ูุงุถุญุฉ

ุงูุขู ูููู ูููุณุชุฎุฏููู ุงุณุชุฎุฏุงู ููุฒุฉ ุญุฏ ุงูุฃุญุฑู ุจุฏูู ุฃู ุฃุฎุทุงุก! ๐